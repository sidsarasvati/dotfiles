#!/usr/bin/env python3
# claude-usage - Minimal Claude Code usage tracker

import json
import os
from pathlib import Path
from datetime import datetime

# Model pricing (cost per token) - from LiteLLM
# Note: These match the official Anthropic pricing
PRICING = {
    'claude-opus-4-20250514': {
        'input': 1.5e-05,        # $15 per million
        'output': 7.5e-05,       # $75 per million
        'cache_create': 1.875e-05,  # $18.75 per million
        'cache_read': 1.5e-06    # $1.50 per million
    },
    'claude-sonnet-4-20241022': {
        'input': 3e-06,          # $3 per million
        'output': 1.5e-05,       # $15 per million
        'cache_create': 3.75e-06,   # $3.75 per million
        'cache_read': 3e-07      # $0.30 per million
    }
}

def main():
    claude_dir = Path.home() / '.claude' / 'projects'
    daily_usage = {}
    
    # Read all JSONL files
    for jsonl_file in claude_dir.glob('**/*.jsonl'):
        with open(jsonl_file, 'r') as f:
            for line in f:
                try:
                    data = json.loads(line)
                    if 'usage' in data.get('message', {}):
                        usage = data['message']['usage']
                        model = data['message'].get('model', 'unknown')
                        timestamp = data.get('timestamp', '')
                        
                        # Get date
                        date = timestamp[:10] if timestamp else 'unknown'
                        
                        # Initialize structures
                        if date not in daily_usage:
                            daily_usage[date] = {}
                        if model not in daily_usage[date]:
                            daily_usage[date][model] = {'input': 0, 'output': 0, 'cache_create': 0, 'cache_read': 0}
                        
                        # Add tokens
                        daily_usage[date][model]['input'] += usage.get('input_tokens', 0)
                        daily_usage[date][model]['output'] += usage.get('output_tokens', 0)
                        daily_usage[date][model]['cache_create'] += usage.get('cache_creation_input_tokens', 0)
                        daily_usage[date][model]['cache_read'] += usage.get('cache_read_input_tokens', 0)
                except:
                    continue
    
    # Calculate costs and display
    print("\nðŸ¤– Claude Usage Summary\n")
    grand_total_cost = 0
    all_dates_cost = 0
    
    # Calculate total for ALL dates first
    for date in sorted(daily_usage.keys()):
        models = daily_usage[date]
        date_cost = 0
        
        for model, usage in models.items():
            if model in PRICING:
                prices = PRICING[model]
                cost = (usage['input'] * prices['input'] + 
                       usage['output'] * prices['output'] + 
                       usage['cache_create'] * prices['cache_create'] + 
                       usage['cache_read'] * prices['cache_read'])
                
                date_cost += cost
        
        all_dates_cost += date_cost
    
    # Show last 7 days with details
    print("Last 7 days:")
    last_7_cost = 0
    for date in sorted(daily_usage.keys())[-7:]:
        models = daily_usage[date]
        date_cost = 0
        date_tokens = 0
        
        for model, usage in models.items():
            if model in PRICING:
                prices = PRICING[model]
                cost = (usage['input'] * prices['input'] + 
                       usage['output'] * prices['output'] + 
                       usage['cache_create'] * prices['cache_create'] + 
                       usage['cache_read'] * prices['cache_read'])
                
                date_cost += cost
                date_tokens += sum(usage.values())
        
        last_7_cost += date_cost
        print(f"  {date}: {date_tokens:,} tokens | ${date_cost:.2f}")
    
    print(f"\nðŸ’° Last 7 days: ${last_7_cost:.2f}")
    print(f"ðŸ’° All time total: ${all_dates_cost:.2f}")

if __name__ == "__main__":
    main()